# Docker Compose for Opus Orchestra Agent Containers
#
# This file is for local development and testing.
# In production, the extension manages containers directly via Docker API.
#
# Usage:
#   docker-compose build sandbox
#   docker-compose run --rm sandbox

version: '3.8'

services:
  sandbox:
    build:
      context: .
      dockerfile: Dockerfile.sandbox
    image: opus-orchestra-sandbox:local

    # Security hardening
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    read_only: true

    # Resource limits
    mem_limit: 4g
    cpus: 2
    pids_limit: 100

    # Writable directories (ephemeral)
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=100m
      - /home/agent:rw,noexec,nosuid,size=500m

    # Network isolation - use host proxy
    # In production, --network=none is used with Unix socket
    network_mode: bridge

    # Volumes - workspace will be mounted at runtime
    volumes:
      - type: bind
        source: ${WORKTREE_PATH:-.}
        target: /workspace

    # User
    user: "1000:1000"

    # Environment
    environment:
      - HTTP_PROXY=http://host.docker.internal:8377
      - HTTPS_PROXY=http://host.docker.internal:8377
      - NO_PROXY=localhost,127.0.0.1
      - GIT_TERMINAL_PROMPT=0

    working_dir: /workspace

    stdin_open: true
    tty: true

  # gVisor variant (requires runsc installed on host)
  sandbox-gvisor:
    extends:
      service: sandbox
    runtime: runsc
    image: opus-orchestra-sandbox:gvisor

  # Proxy service for credential injection and domain filtering
  proxy:
    build:
      context: .
      dockerfile: Dockerfile.proxy
    image: opus-orchestra-proxy:local
    ports:
      - "8377:8377"
    volumes:
      - type: bind
        source: ${PROXY_CONFIG:-./proxy-config.json}
        target: /etc/opus-orchestra/config.json
        read_only: true
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
